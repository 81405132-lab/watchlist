<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è¿½åŠ‡æ¸…å–®</title>
  <style>
    :root { --bg:#0b0f17; --card:#121a26; --muted:#8aa0bd; --text:#e8f0ff; --accent:#6ea8ff; --danger:#ff6e6e; }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif}
    body{margin:0;background:linear-gradient(180deg,#071021,#0b0f17);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:22px}
    header{display:flex;gap:14px;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:22px}
    .pill{color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px;margin-top:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:#121a26;border-radius:16px;padding:14px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;margin-top:6px;padding:8px;border-radius:10px;border:1px solid #1e2a40;background:#0a1220;color:var(--text)}
    textarea{resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    button{padding:8px 12px;border-radius:10px;border:0;cursor:pointer;background:#6ea8ff;color:#061021}
    button.danger{background:#ff6e6e}
    button.sub{background:#1e2a40;color:var(--text)}
    .toolbar select,.toolbar input{width:auto}
    .list .item{display:grid;grid-template-columns:70px 1fr auto;gap:12px;background:#0a1220;padding:10px;border-radius:12px;margin-top:10px}
    .poster{width:70px;height:95px;background:#1e2a40;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--muted)}
    .meta h3{margin:0}
    .small{font-size:12px;color:var(--muted)}
    .tag{background:#6ea8ff;color:#061021;font-size:11px;padding:2px 8px;border-radius:999px;margin-right:4px}
    .actions button{margin-left:6px}
  </style>
</head>

<body>
<div class="wrap">

<header>
  <div>
    <h1>è¿½åŠ‡æ¸…å–®</h1>
    <div class="pill">è§€çœ‹æ™‚é–“çµ±è¨ˆï¼ˆç²¾æº–åˆ°åˆ†é˜ï¼‰ï¼‹ Top20 æ’è¡Œæ¦œ</div>
  </div>
  <div class="toolbar">
    <input id="q" placeholder="æœå°‹">
    <select id="sortBy">
      <option value="updatedDesc">æœ€è¿‘æ›´æ–°</option>
      <option value="ratingDesc">è©•åˆ†é«˜â†’ä½</option>
      <option value="titleAsc">åŠ‡å Aâ†’Z</option>
      <option value="progressDesc">é€²åº¦é«˜â†’ä½</option>
      <option value="watchedTimeDesc">è§€çœ‹æ™‚é–“é•·â†’çŸ­</option>
    </select>
  </div>
</header>

<div class="grid">

<!-- å·¦ï¼šè¡¨å–® -->
<div class="card">
  <input type="hidden" id="id">
  <label>åŠ‡å</label>
  <input id="title">

  <div class="row">
    <div>
      <label>å·²çœ‹é›†æ•¸</label>
      <input id="epNow" type="number">
    </div>
    <div>
      <label>ç¸½é›†æ•¸</label>
      <input id="epTotal" type="number">
    </div>
  </div>

  <label>å–®é›†é•·åº¦ï¼ˆåˆ†é˜ï¼‰</label>
  <input id="epMinutes" type="number">

  <label>è©•åˆ†</label>
  <input id="rating" type="number" step="0.5">

  <label>å‚™è¨»</label>
  <textarea id="notes"></textarea>

  <br>
  <button onclick="save()">å„²å­˜</button>
  <button class="sub" onclick="resetForm()">æ¸…ç©º</button>
</div>

<!-- å³ï¼šæ¸…å–® -->
<div class="card">
  <div class="small" id="stats"></div>
  <div class="small" id="ranking"></div>
  <div class="list" id="list"></div>
</div>

</div>
</div>

<script>
const KEY="watch_rank_20";
const $=id=>document.getElementById(id);
let items=JSON.parse(localStorage.getItem(KEY)||"[]");

function minToHM(m){
  const h=Math.floor(m/60), mm=m%60;
  if(h&&mm) return `${h}å°æ™‚${mm}åˆ†`;
  if(h) return `${h}å°æ™‚`;
  return `${mm}åˆ†`;
}

function save(){
  const id=$("id").value||Date.now();
  const it={
    id,
    title:$("title").value,
    epNow:+$("epNow").value||0,
    epTotal:+$("epTotal").value||null,
    epMinutes:+$("epMinutes").value||0,
    rating:+$("rating").value||0,
    notes:$("notes").value,
    updated:Date.now()
  };
  const i=items.findIndex(x=>x.id==id);
  if(i>=0) items[i]=it; else items.push(it);
  localStorage.setItem(KEY,JSON.stringify(items));
  resetForm(); render();
}

function resetForm(){
  ["id","title","epNow","epTotal","epMinutes","rating","notes"].forEach(i=>$(i).value="");
}

function render(){
  const q=$("q").value?.toLowerCase()||"";
  let arr=items.filter(i=>i.title.toLowerCase().includes(q));

  if($("sortBy").value==="watchedTimeDesc"){
    arr.sort((a,b)=>(b.epNow*b.epMinutes)-(a.epNow*a.epMinutes));
  }

  $("list").innerHTML="";
  arr.forEach(it=>{
    const watched=it.epNow*it.epMinutes;
    const remain=it.epTotal?Math.max(0,(it.epTotal-it.epNow)*it.epMinutes):0;
    $("list").innerHTML+=`
    <div class="item">
      <div class="poster">Poster</div>
      <div class="meta">
        <h3>${it.title}</h3>
        <div class="small">å·²çœ‹ ${minToHM(watched)} ï½œ æœªçœ‹ ${minToHM(remain)}</div>
      </div>
      <div class="actions">
        <button onclick="it.epNow++;save()">+1</button>
      </div>
    </div>`;
  });

  renderStats();
  renderRanking();
}

function renderStats(){
  let w=0,r=0;
  items.forEach(it=>{
    w+=it.epNow*it.epMinutes;
    if(it.epTotal) r+=(it.epTotal-it.epNow)*it.epMinutes;
  });
  $("stats").textContent=`ç¸½å·²çœ‹ ${minToHM(w)} ï½œ ç¸½æœªçœ‹ ${minToHM(r)}`;
}

function renderRanking(){
  const top=[...items]
    .filter(i=>i.epMinutes&&i.epNow)
    .sort((a,b)=>(b.epNow*b.epMinutes)-(a.epNow*a.epMinutes))
    .slice(0,20);

  $("ranking").innerHTML="ğŸ† Top 20 è§€çœ‹æ™‚é–“æ’è¡Œæ¦œ<br>"+top.map((i,n)=>
    `${n+1}. ${i.title}ï½œ${minToHM(i.epNow*i.epMinutes)}`
  ).join("<br>");
}

$("q").oninput=render;
$("sortBy").onchange=render;
render();
</script>
</body>
</html>
